shallow_clone: true

skip_commits:
  files:
    - .github/**/*
    - '**/*.md'
    - '**/*.html'
    - '**/*.htm'
    - '**/*.tex'

version: '{build}'

os:
  - Visual Studio 2022

platform:
  - x64

configuration:
  - Release

build:
  verbosity: detailed

environment:
  CMAKE_INSTALL_PREFIX: C:\projects\stir\install\
  DEPS: C:\projects\deps
  sccache_VER: 0.3.3

install:
  - IF NOT EXIST %DEPS% mkdir %DEPS%
  - cd %DEPS%
  - set sccache_FULLNAME="sccache-v%sccache_VER%-x86_64-pc-windows-msvc"
  - set sccache_URL="https://github.com/mozilla/sccache/releases/download/v%sccache_VER%/%sccache_FULLNAME%.zip"
  - IF NOT EXIST %DEPS%\sccache-%sccache_VER%.zip appveyor DownloadFile %sccache_URL% -FileName sccache-%sccache_VER%.zip
  - IF NOT EXIST %DEPS%\sccache.exe 7z x sccache-%sccache_VER%.zip -o%DEPS%\
  - IF NOT EXIST %DEPS%\sccache.exe move %sccache_FULLNAME%\*.* .

build_script:
  - cd C:\projects\STIR
  - REM path=%path%;%DEPS%
  - REM sccache --show-stats
  # find boost on Appveyor. Version depends on VM
  - for /D %%d in (C:\Libraries\boost_*) do set BOOST_ROOT=%%d
  - echo Using Boost %BOOST_ROOT%
  - mkdir build
  - mkdir install
  - cd build
  - cmake --version
  - cmake.exe .. -G Ninja -DCMAKE_INSTALL_PREFIX=%CMAKE_INSTALL_PREFIX% -DCMAKE_BUILD_TYPE=%CONFIGURATION%  -DCMAKE_CONFIGURATION_TYPES=%CONFIGURATION% -DSTIR_OPENMP=ON -DBUILD_DOCUMENTATION:BOOL=OFF
  - REM DCMAKE_C_COMPILER_LAUNCHER=sccache -DCMAKE_CXX_COMPILER_LAUNCHER=sccache
  - cmake.exe --build . --config %CONFIGURATION%
  - cmake.exe --build . --target install --config %CONFIGURATION%
  - REM sccache --show-stats

cache:
  - c:\projects\deps\sccache-%sccache_VER%.zip
  # - C:\Users\appveyor\AppData\Local\Mozilla\sccache\cache

test_script:
  - cd C:\projects\stir\build
  - ctest --output-on-failure  -C %CONFIGURATION%
  - cd ..\recon_test_pack
  - run_tests --nointbp "C:\projects\stir\install\bin\"
