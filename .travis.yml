# Language selection
language: cpp

# Both clang and gcc can be tested. The more is the better.
compiler:
  - clang
  - gcc

# Cross-operating system test
os:
  - linux
  - osx

# Environment variables:
# To avoid too many builds, we mix some options (although independent tests would have been better)
env:
  matrix:
  - EXTRA_BUILD_FLAGS="-DDISABLE_CERN_ROOT_SUPPORT=0"
  - EXTRA_BUILD_FLAGS="-DDISABLE_CERN_ROOT_SUPPORT=1"
  global:
    - BUILD_FLAGS="-DBUILD_SWIG_PYTHON:BOOL=On -DSTIR_MPI:BOOL=Off -DSTIR_OPENMP:BOOL=Off -DCMAKE_BUILD_TYPE=Release"

# Ubuntu 14.04 LTS (trusty)
dist: trusty

# No need for sudo
sudo: false

# Compilation dependencies
addons:
  apt:
    packages:
      - libboost-all-dev
      - swig
      - libgomp1
      - root-system-bin
      - libroot-tree-dev
      - libroot-tree-treeplayer-dev
      - libroot-io-dev

# Actual compilation script

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew tap homebrew/science; fi
  # seems to be needed on Travis due to conflicts with gcc otherwise
  # see https://github.com/travis-ci/travis-ci/issues/8826
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew cask uninstall oclint;fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install doxygen; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install --with-cocoa root; fi
  # use Python3 on Mac, not the system Python (which doesn't have pip etc)
  # from http://blog.fizyk.net.pl/blog/running-python-tests-on-traviss-osx-workers.html
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install python3; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then virtualenv venv -p python3; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then source venv/bin/activate; fi
  - python -m pip install -U pip
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then 
      python -m pip install pytest;
    else
      python -m pip install --user pytest;
    fi

script:
  - mkdir build install
  - cd build
  - cmake $BUILD_FLAGS $EXTRA_BUILD_FLAGS -DCMAKE_INSTALL_PREFIX=$TRAVIS_BUILD_DIR/install -DBUILD_EXECUTABLES=OFF ..
  - make -j 2 all
  - make test
  - make install
  - export PATH=$PATH:$TRAVIS_BUILD_DIR/install/bin
  - cd $TRAVIS_BUILD_DIR/recon_test_pack
  - #./run_test_simulate_and_recon.sh
  - #./run_test_simulate_and_recon_with_motion.sh
  - #./run_scatter_tests.sh
  - #./run_tests.sh --nointbp
  - # if [[ $EXTRA_BUILD_FLAGS == *"DDISABLE_CERN_ROOT_SUPPORT=0"* ]]; then ./run_root_GATE.sh; fi
  - cd $TRAVIS_BUILD_DIR/recon_test_pack/SPECT
  - #./run_SPECT_tests.sh
  - cd $TRAVIS_BUILD_DIR/src
  # Run Python tests, making sure we're using the correct Python interpreter
  - ls $TRAVIS_BUILD_DIR/install/python
  - PYTHONPATH=$TRAVIS_BUILD_DIR/install/python python -m pytest .
  